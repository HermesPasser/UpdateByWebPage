# frozen_string_literal: false

links_v1 = [
	["https://sabishiidesu.com/maou-sama-kansatsu-nikki/introduction-1","Character Introduction"],
	["https://sabishiidesu.com/2019/09/01/maou-sama-v1c1","Chapter 1 - The Demon King Observation Diary"],
	["https://sabishiidesu.com/2019/09/01/maou-sama-v1c2","Chapter 2 - Distress"],
	["https://sabishiidesu.com/2019/09/02/maou-sama-v1c3","Chapter 3 - The World Tree"],
	["https://sabishiidesu.com/2019/09/02/maou-sama-v1c4","Chapter 4 - Elves"],
	["https://sabishiidesu.com/2019/09/03/maou-sama-v1c5","Chapter 5 - Humans"],
	["https://sabishiidesu.com/2019/09/04/maou-sama-v1c6","Chapter 6 - Restraint"],
	["https://sabishiidesu.com/2019/09/05/maou-sama-v1c7","Chapter 7 - Bandits"],
	["https://sabishiidesu.com/2019/09/05/maou-sama-v1c8","Chapter 8 - Village Chief"],
	["https://sabishiidesu.com/2019/09/06/maou-sama-v1c9","Chapter 9 - Villagers"],
	["https://sabishiidesu.com/2019/09/07/maou-sama-v1c10","Chapter 10 - Inn and Church"],
	["https://sabishiidesu.com/2019/09/09/maou-sama-v1c11","Chapter 11 - General Store and Guild"],
	["https://sabishiidesu.com/2019/09/22/maou-sama-v1c12","Chapter 12 - Sodogora Village"],
	["https://sabishiidesu.com/2019/11/23/maou-sama-v1c13","Chapter 13 - The Adventurer Guild"],
	["https://sabishiidesu.com/2019/11/25/maou-sama-v1c14","Chapter 14 - Business"],
	["https://sabishiidesu.com/2019/11/27/maou-sama-v1c15","Chapter 15 - Job Request"],
	["https://sabishiidesu.com/2020/01/16/maou-sama-v1c16","Chapter 16 - Waitress"],
	["https://sabishiidesu.com/2020/01/17/maou-sama-v1c17","Chapter 17 - Job Search"],
	["https://sabishiidesu.com/2020/01/18/maou-sama-v1c18","Chapter 18 - Sunflower"],
	["https://sabishiidesu.com/2020/01/20/maou-sama-v1c19","Chapter 19 - Taken"],
	["https://sabishiidesu.com/2020/01/23/maou-sama-v1c20","Chapter 20 - Demon Race"],
	["https://sabishiidesu.com/2020/01/25/maou-sama-v1c21","Chapter 21 - Friendship"],
	["https://sabishiidesu.com/2020/02/01/maou-sama-v1c22","Chapter 22 - Situation"],
	["https://sabishiidesu.com/2020/02/10/maou-sama-v1c23","Chapter 23 - Beastfolks"],
	["https://sabishiidesu.com/2020/02/14/maou-sama-v1c24","Chapter 24 - Escaped"],
	["https://sabishiidesu.com/2020/02/16/maou-sama-v1c25","Chapter 25 - Departure"],
	["https://sabishiidesu.com/2020/03/16/maou-sama-v1c26","Chapter 26 - Bandit Subjugation"],
	["https://sabishiidesu.com/2020/04/25/maou-sama-v1c27","Chapter 27 - Appraisal"],
	["https://sabishiidesu.com/2020/05/03/maou-sama-v1c28","Chapter 28 - Secret"],
	["https://sabishiidesu.com/2020/05/04/maou-sama-v1c29","Chapter 29 - Smile"],
	["https://sabishiidesu.com/2020/05/14/maou-sama-v1c30","Chapter 30 - Demonic Eyes"],
	["https://sabishiidesu.com/2020/06/12/maou-sama-v1c31","Chapter 31 - Skills"],
	["https://sabishiidesu.com/2020/06/12/maou-sama-v1c32","Chapter 32 - Compensation"],
	["https://sabishiidesu.com/2020/07/20/maou-sama-v1c33","Chapter 33 - Deficit"],
	["https://sabishiidesu.com/2020/07/20/maou-sama-v1c34","Chapter 34 - Unemployment"],
	["https://sabishiidesu.com/2020/07/30/maou-sama-v1c35","Chapter 35 - Marriage"],
	["https://sabishiidesu.com/2020/07/30/maou-sama-v1c36","Chapter 36 - The Goddess Religion"],
	["https://sabishiidesu.com/2020/08/06/maou-sama-v1c37","Chapter 37 - Subordinates"],
	["https://sabishiidesu.com/2020/08/10/maou-sama-v1c38","Chapter 38 - Development Department"],
	["https://sabishiidesu.com/2020/08/16/maou-sama-v1c39","Chapter 39 - Concentration"],
	["https://sabishiidesu.com/2020/08/16/maou-sama-v1c40","Chapter 40 - Fun Time"],
	["https://sabishiidesu.com/2020/08/16/maou-sama-vol-1-intermission","Intermission - Unlucky Man"]
]

links_v2 = [
	["https://sabishiidesu.com/2020/08/24/maou-sama-v2c1/","Chapter 1 - Suspect"],
	["https://sabishiidesu.com/2020/08/28/maou-sama-v2c2/","Chapter 2 - Proposal"],
	["https://sabishiidesu.com/2020/08/30/maou-sama-v2c3/","Chapter 3 - Praying Mantis"],
	["https://sabishiidesu.com/2020/09/01/maou-sama-v2c4/","Chapter 4 - Long-lived Race"],
	["https://sabishiidesu.com/2020/09/06/maou-sama-v2c5/","Chapter 5 - Apple Thieves"],
	["https://sabishiidesu.com/2020/10/02/maou-sama-v2c6/","Chapter 6 - The Elders"],
	["https://sabishiidesu.com/2020/10/07/maou-sama-v2c7/","Chapter 7 - Identity"],
	["https://sabishiidesu.com/2020/12/03/maou-sama-v2c8/","Chapter 8 - Interrogation"],
	["https://sabishiidesu.com/2020/12/06/maou-sama-v2c9/","Chapter 9 - Chatter"],
	["https://sabishiidesu.com/2020/12/20/maou-sama-v2c10/","Chapter 10 - Sleep Disturbance"],
	["https://sabishiidesu.com/2020/12/23/maou-sama-v2c11/","Chapter 11 - Rematch"],
	["https://sabishiidesu.com/2021/01/03/maou-sama-v2c12/","Chapter 12 - The Circumstances of Demons Race"],
	["https://sabishiidesu.com/2021/01/04/maou-sama-v2c13/","Chapter 13 - The Wise God"],
	["https://sabishiidesu.com/2021/01/06/maou-sama-v2c14/","Chapter 14 - The Angels"],
	["https://sabishiidesu.com/2021/01/09/maou-sama-v2c15/","Chapter 15 - Diary"],
	["https://sabishiidesu.com/2021/01/23/maou-sama-v2c16/","Chapter 16 - Dere"],
	["https://sabishiidesu.com/2021/02/09/maou-sama-v2c17/","Chapter 17 - Feast"],
	["https://sabishiidesu.com/2021/02/10/maou-sama-v2c18/","Chapter 18 - Siege"],
	["https://sabishiidesu.com/2021/02/18/maou-sama-v2c19/","Chapter 19 - Pajama Party"],
	["https://sabishiidesu.com/2021/02/23/maou-sama-v2c20/","Chapter 20 - Fog"],
	["https://sabishiidesu.com/2021/02/27/maou-sama-v2c21/","Chapter 21 - Emperor"],
	["https://sabishiidesu.com/2021/04/25/maou-sama-v2c22/","Chapter 22 - Responsabilities"],
	["https://sabishiidesu.com/2021/04/29/maou-sama-v2c23/","Chapter 23 - Opinion"],
	["https://sabishiidesu.com/2021/05/01/maou-sama-v2c24/","Chapter 24 - The Return Preparation"],
	["https://sabishiidesu.com/2021/05/08/maou-sama-v2c25/","Chapter 25 - Return"],
]

require 'open-uri'
require_relative '../shared'

def download_img_and_update_tag html
	pattern =  /https:\/\/sabishiidesu.com\/wp-content\/uploads\/(.*?).png/
	results = match_all(html, pattern, true)
	results.each do |url|
		filename = File.basename(url)
		puts " Image - #{url}"
		download_image(url, filename)
		html.gsub!(url, filename)
	end
	html
end

def download links, filename
	final_content = "<!DOCTYPE html> <head></head><body>"
	print filename
	links.each do |l, n|
		puts " #{n}..."
		URI.open(l) do |con|
			content = con.read
			# replace  non breaking space (basically a tab) with nothing since utf will show as '?' and html will ignore " " and "\t"
			# TODO: try replicate it with css
			content.encode!("ASCII", Encoding::UTF_8, undef: :replace, :replace  => "") 
			istart = content.index("<div class=\"entry-content\">")
			iend = content.index("<!-- .entry-content -->")
			final_content += content[istart...iend]
		end
	end

	final_content += download_img_and_update_tag final_content
	final_content += "</body></html>"
	open(filename, "w+") { |f| f.write(final_content) }
end

puts "Downloading "
download  links_v1, "maou-sama-kansatsu-nikki-v1.html"
download  links_v2, "maou-sama-kansatsu-nikki-v2.html"
